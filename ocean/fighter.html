<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ocean fighter</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel=stylesheet href="./common.css">	
	</head>
	<body >
			<!--<audio src="sound/wave.mp3" preload="auto" autoplay loop></audio>
			<audio src="sound/whistle.mp3" preload="auto" autoplay></audio> -->

		 <!--<script src="https://threejs.org/build/three.js"></script> -->
		 <script src="./../three/three.min.js"></script>
		


		<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
		<script src="./../three/TrackObjectControls.js"></script>
		<script src="https://threejs.org/examples/js/Mirror.js"></script>
		<script src="https://threejs.org/examples/js/WaterShader.js"></script>

		<script src="https://threejs.org/examples/js/Detector.js"></script>
		<script src="https://threejs.org/examples/js/libs/stats.min.js"></script>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

		<!-- tracking -->
        <script type="text/javascript" src="./../jsfeat/jsfeat-min.js"></script>
        <script type="text/javascript" src="./../jsfeat//compatibility.js"></script>
        <script type="text/javascript" src="./../jsfeat/profile.js"></script>
        <script type="text/javascript" src="./../webrtc/device_cam.js"></script>
        <script type="text/javascript" src="./../jsfeat/screen_flow.js"></script>

        <!-- data chanel -->
        <script src="https://rtc-world-s.herokuapp.com/socket.io/socket.io.js"></script> 
        <script type="text/javascript" src="./../webrtc/chanel.js"></script>
        <!--<script type="text/javascript" src="./../webrtc/chanel_control.js"></script> -->

        <script type="text/javascript" src="./../webrtc/util.js"></script>
        <script type="text/javascript" src="./ocean2.js"></script>

        <!-- fire -->
		<script src="./fire/VolumetricFire.js"></script>

		<!-- cloud -->
		<div id="css-cloud-world"></div>

		<!-- 自機 -->
		<div id="own-fighter-view">
			<img id="own-fighter-view-img" src="./images/fighter_view/zero_fighter2.png"/>
		</div>

        <!-- UI parts -->
        <div class="ui-widgets">

        	

	       	<!-- start screen -->
	      	<div class="select-fighter-container">
	      		<div class="model-detail">

	      			<div class="model-name"></div>

	      			<div class="performance-list">

	      				<div class="performance-elem performance-power">
	      					<div class="performance-title">馬力 : </div>
	      					<span class="performance-number"> 20 </span>

	      					<div class="performance-bar"></div>
	      				</div>
	      				
	      				<div class="performance-elem performance-fire">
	      					<div class="performance-title">火力 : </div>
	      					<div class="performance-number">10</div>
	      					<div class="performance-bar"></div>
	      				</div>

	      				<div class="performance-elem performance-rotation">
	      					<div class="performance-title">旋回能力 : </div>
	      					<div class="performance-number">30</div>
	      					<div class="performance-bar"></div>
	      				</div>
	      				
	      				<div class="performance-elem performance-rising">
	      					<div class="performance-title">上昇力 : </div>
	      					<div class="performance-number">20</div>
	      					<div class="performance-bar"></div>
	      				</div>

	      				<img class="nation-flag"></img>
	      			</div>
	      		</div>

	      		<div class="select-arrows">
	      			<div class="arrow-group left-arrow-group">
	      				<div class="arrow-part arrow-top-part"></div>
	      				<div class="arrow-part arrow-bottom-part"></div>
	      			</div>

	      			<div class="arrow-group right-arrow-group">
	      				<div class="arrow-part arrow-top-part"></div>
	      				<div class="arrow-part arrow-bottom-part"></div>
	      			</div>

	      		</div>

	        	<div class="ui-button-mini start-button">
	        		<div class="hexagon2"></div>
	        		<div class="hexagon disable"> Loading..</div>
	        	</div>
	        </div>

	        	<!-- controls -->
	        <div class="info">
	        	<ul class="info-items" style="display: none;">
	        		<li class="info-li">
	        			<span class="item-title">fps</span>
	        			<span class="item-value fps"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">member</span>
	        			<span class="item-value member"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">x_pos</span>
	        			<span class="item-value x_pos"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">y_pos</span>
	        			<span class="item-value y_pos"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">z_pos</span>
	        			<span class="item-value z_pos"><input type="text"></span>
	        		</li>
	        		<!--
	        		<li class="info-li">
	        			<span class="item-title">x_rot</span>
	        			<span class="item-value x_rot"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">y_rot</span>
	        			<span class="item-value y_rot"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<span class="item-title">z_rot</span>
	        			<span class="item-value z_rot"><input type="text"></span>
	        		</li>
					-->
					<li class="info-li">
	        			<span class="item-title">score</span>
	        			<span class="item-value score"><input type="text"></span>
	        		</li>
	        		<li class="info-li">
	        			<div class="info-button" id="be-shot"> Be shot </div>
	        		</li>

	        		<li class="info-li">
	        			<div class="info-button" id="pause"> pause </div>
	        		</li>


	        		<!--
	        		<li class="info-li">
	        			<span class="on-off-title"> ship move </span> 
	        			<input type="checkbox" id="ship-move-toggle" class="info-on-off-button"><label for="toggleButton"></label>
	        		</li>
	        		<li class="info-li">
	        			<span class="on-off-title"> sound </span> 
	        			<input type="checkbox" id="sound-toggle" class="info-on-off-button"><label for="toggleButton"></label>
	        		</li>
	        		-->
	        	</ul>
	        	<div class="open-button info-toggle-button">Open Controls</div>
	        </div>

	        <!-- flying screen -->
	        <div class="sighting" style="display: none;"></div>
	        <div class="meter-group" style="display:none">
	        	<div class="meter" id="feet-meter"></div>
	        	<div class="meter" id="compass-meter"></div>
	        	<div class="life-gauge-group" id="life-gauge">
	        		<div id="life-gauge-child"></div>
	        	</div>
	        </div>
	        <div class="blood-splash hide"></div>

	       
	        
	        <div class="game-over" style="display: none;">
	        	<p>Game Over</p>
	        	<div class="ui-button restart-button">
	        		<div class="hexagon2"></div>
	        		<div class="restart-button hexagon"> Restart </div>
	        	</div>
	        	<div class="ui-button back-button">
	        		<div class="hexagon2"></div>
	        		<div class="back-button hexagon"> Back </div>
	        	</div>
	        </div>
	    </div>
		
		<script>

		'use strict';
		$(function(){
			const isOrbitControl = false;
			var controls;
			let isShipMove = false;
			
			// Compass
			let hasCompass = false; // 
			let compassdir = {};
			let compass_as_zero_limit = 1e-10;

			let controlFighterId;
			let keyInputs = {
				vertical: 0,
				horizontal: 0,
				horizontalIntegrated: 0,
				space: false
			};
			const keyIputCoefficient = 0.1;

			// 情報表示
			let infoControls = {
				$x_pos: $(".x_pos input"),
				$y_pos: $(".y_pos input"),
				$z_pos: $(".z_pos input"),
				$x_rot: $(".x_rot input"),
				$y_rot: $(".y_rot input"),
				$z_rot: $(".z_rot input"),
				$score: $(".score input"),
				$fps : $(".fps input"),
				$member : $(".member input")
			};
			$(".info-toggle-button").bind("click", function(){
				if($(this).hasClass("close-button")){
					$(this).removeClass("close-button");
					$(this).addClass("open-button");
					$(".info-items").hide();
					$(this).text("Open Controls");
				}else{
					$(this).removeClass("open-button");
					$(this).addClass("close-button");
					$(".info-items").show();
					$(this).text("Close Controls");					
				}
			});

			$("#be-shot").bind("click", function(){
				//bomb_audio.play();
				//explosion_audio.play();
				beShot();
			});

			$("#ship-move-toggle").bind("change", function(){
				if($(this).is(":checked")){
					isShipMove = true;
				}else{
					isShipMove = false;
				}	
			});

			/*
			$("#sound-toggle").bind("change", function(){
				if($(this).is(":checked")){
					wave_audio.play();
					whistle_audio.play();
				}else{
					wave_audio.pause();
					whistle_audio.pause();

				}	
			});
			*/

			$(".info-on-off-button").parent().bind("click", function(){
				var $input = $(this).find("input");
				$input.prop("checked", !$input.prop("checked")).change();
			});	

			// 照準
			$(".sighting").bind("click", function(){
				//shoot_audio.play();
				oceanControl.oneShoot(controlFighterId);
			});

			if ( ! Detector.webgl ) {

				Detector.addGetWebGLMessage();
				document.getElementById( 'container' ).innerHTML = "";

			}

			// デバイスの傾き
			$( window ).on( "deviceorientation", function(e){
				var evenet = e.originalEvent;

				hasCompass = evenet.absolute;
				if(hasCompass){
					if(event.webkitCompassHeading) {
						// Apple works only with this, alpha doesn't work
						compassdir = event.webkitCompassHeading;  
					}
					else
					{ 
						var k = 3.1415 * 2/360.0;
						compassdir.x = event.gamma * k;//event.alpha * k + 1.5
						compassdir.y = event.beta * k;
						compassdir.z = 0.0;//event.gamma * k;
						// 値が小さい時は水平とする
						if(Math.abs(compassdir.x) < compass_as_zero_limit){
							compassdir.x = 0.0;
						}
						if(Math.abs(compassdir.y) < compass_as_zero_limit){
							compassdir.y = 0.0;
						}
					}
				}
			});

			// key inputs # TODO pcのみにしたい
			$( document ).on( "keydown", function( event ) {
			  	switch( event.keyCode ) {
			  	// left
			    case 37:
			    case 65:
			      keyInputs.horizontal = - keyIputCoefficient;
			      break;
			     // right
			    case 39:
			    case 68:
			      keyInputs.horizontal = keyIputCoefficient;
			      break;
			    // up
			    case 38:
			    case 87:
			      keyInputs.vertical = keyIputCoefficient;
			      break;
			    // down
			    case 40:
			    case 83:
			      keyInputs.vertical = -keyIputCoefficient;
			      break;
			    // space
			    case 32:
			    	keyInputs.space = true;
			    	//shoot_audio.play();
					oceanControl.oneShoot(controlFighterId);
			  		break;
			  }
			});

			$( document ).on( "keyup", function( event ) {
			  	switch( event.keyCode ) {
			  	// left
			    case 37:
			    case 65:
			     // right
			    case 39:
			    case 68:
			      keyInputs.horizontal = 0;
			      break;
			    // up
			    case 38:
			    case 87:
			    // down
			    case 40:
			    case 83:
			      keyInputs.vertical = 0;
			      break;
			    // space
			    case 32:
			    	keyInputs.space = false;
			  	break;
			  }
			});
		
	        const camera_init_pos = [0,100,0];
let s = 40;
	        let fighterList = [
	        	{
	        		modelName: "battle_ship",
	        		scale: [s, s, s],  // 10
					pos: [1800, 50, 500],
					rot: [0, Math.PI/2, 0],
					vel : new THREE.Vector3(100,0,0)
	        	},
	        	{
	        		modelName: "battle_ship",
					pos: [1800, 200, 0],
					rot: [-Math.PI/5.0, -Math.PI/3, Math.PI/100],
	        	},
	        	{
	        		modelName: "p51_mustang",
					pos: [1200, 5000, -2500],
					rot: [ Math.PI/4 ,Math.PI/4,0],
	        	},
	        	{
	        		modelName: "p51_mustang",
					pos: [1200, 1000, -1000],
					rot: [ Math.PI/4 , -Math.PI/6,0],
				}
	        ];

	        let myFighterData = {
        		modelName: "zero_fighter",
				center: [0, 14, -34],
				pos: [1800, 300, -5000],
				rot: [0, 0,0],
				fixCam: true,
				control: true,
				//vel: new THREE.Vector3(0,0,1000)
        	};

	        var animateCallback = function(camera, option){
	        	//console.log(option);
	        	infoControls.$x_pos.val(Math.floor(camera.position.x));
				infoControls.$y_pos.val(Math.floor(camera.position.y));
				infoControls.$z_pos.val(Math.floor(camera.position.z));
				//infoControls.$x_rot.val(camera.rotation.x);
				//infoControls.$y_rot.val(camera.rotation.y);
				//infoControls.$z_rot.val(camera.rotation.z);
	            infoControls.$fps.val(Math.floor(option.fps));
	            infoControls.$score.val(Math.floor(option.myScorePoint));
	            infoControls.$member.val(`${option.memberNum} ${option.userId} `);

			}

	        let $startButton = $(".start-button .hexagon");

	        // 3dビュー作成
	        let oceanControl = new Ocean({
				animateCallback: animateCallback,
				isUseChanel: true,
				isFlowTracking : false,
				isOrbitControl: false,
				camera: {
					pos: camera_init_pos
				},
				isLockSideScreen: true,
				meters : {
					"feet" : $("#feet-meter"),
					"compass" : $("#compass-meter"),
					"life_gauge": $("#life-gauge-child") 
				},
				succsessFunc: self => {
					$startButton.text("Start");
					$startButton.removeClass("disable");

					// #TODO ここ、モデル変更部分と共通化させる
					let modelName = "zero_fighter";
					setModelInSelect(modelName);
					nextId = uuid();
					oceanControl.addFighter({
						modelName: modelName,
						pos: [0, 100, -200],
						rot: [0.1,  0.5 , 0],
						vel : [300, 0,0],
						isPrivate: true
					} ,nextId , true);

					objectControl = oceanControl.setObjectControl(true, nextId, $(".select-fighter-container").get(0));
					objectControl.autoRotate = true;



					$(".left-arrow-group").click(function(){
						changeSelectModel(-1);
					});

					$(".right-arrow-group").click(function(){
						changeSelectModel(1);
					});

					self.cloudController.generate();
					console.log("succsessFunc");

					
				},
				beShotCallback: (isMe, id, life) => {
					if(isMe){
						beShot();
						if(life == 0){
							$(".game-over").show();
						}
					}
				}
			});

			$startButton.click(function(){
				if($(this).hasClass("disable"))
					return;
				objectControl.destroy();
				oceanControl.OnClickStart("fighter_audio");
				//$(this).parent().hide();
				$(".select-fighter-container").hide();
				$(".start-back").hide();
				$(".sighting").show();
				$(".meter-group").show();

				 // モデル追加
				for(let index in fighterList){
					let id = oceanControl.createFighter(fighterList[index]);
				}
				
				oceanControl.deleteFighter(nextId);

				//自機
				myFighterData.modelName =  modelNames[selectModelIndex];;
				
				const initPosSize = 50000;
				const initHeightHighest = 8000;
				const initHeightLowest = 1000;
				let rad = Math.random() * Math.PI * 2.0;
				let initPosX = initPosSize * Math.sin(rad);
				let initPosZ = initPosSize * Math.cos(rad);
				let initPosY = (initHeightHighest - initHeightLowest) * Math.random() + initHeightLowest;
				myFighterData.pos = [initPosX, initPosY, initPosZ];
				//let eul = new THREE.Euler();
				//eul.setFromVector3 ( new THREE.Vector3(-initPosX, -initPosY, initPosZ), "YXZ" );
				//myFighterData.rot = [eul.x, eul.y, eul.z];

				controlFighterId = oceanControl.createFighter(myFighterData);
				oceanControl.setControlFighter(controlFighterId);
				oceanControl.applyPerformanceVelocity(controlFighterId, new THREE.Vector3(-initPosX, -initPosY, -initPosZ));
			});

			let debugPause = false;
			$("#pause").click(function(){
				debugPause = !debugPause;
			});
		
			
			oceanControl.setControlCallback(function(){
				if(hasCompass){
					return {
						control: {
							horizontal: compassdir.y,
							vertical: - compassdir.x - Math.PI/6.0,
							acceleration: 1.0,
							debugPause: debugPause
						}
					}
				} else {
					keyInputs.horizontalIntegrated += keyInputs.horizontal/100.0;
					return {
						control: {
							horizontal: keyInputs.horizontalIntegrated ,
							vertical: keyInputs.vertical,
							acceleration: 1.0,
							debugPause: debugPause
						}
					}
				} 
			});

			$(".restart-button").click(function(){
				location.reload();
			});

			$(".back-button").click(function(){
				location.href = "./..";
			});

			// objectControl のバブリング対策
			Util.stopEventPropagation(".model-detail", ["mousedown", "touchstart"]);
		

			// パネル表示
			function setModelInSelect(modelName){
				let model = Ocean.Models[modelName];
				if(!model)
					return;

				$(".select-fighter-container .model-name").text(model.modelName);
				$(".performance-power .performance-number").text(model.performance.power);
				$(".performance-power .performance-bar").width(`${model.performance.power}%`);

				$(".performance-fire .performance-number").text(model.performance.fire);
				$(".performance-fire .performance-bar").width(`${model.performance.fire}%`);

				$(".performance-rotation .performance-number").text(model.performance.rotation);
				let $bar = $(".performance-rotation .performance-bar");
				$bar.css(" transition-duration", "0s");
				$bar.width(0);
				$bar.css(" transition-duration", "0.3s");
				$bar.width(`${model.performance.rotation}%`);

				$(".performance-rising .performance-number").text(model.performance.rising);
				$(".performance-rising .performance-bar").width(`${model.performance.rising}%`);


				$(".performance-list img.nation-flag")
					.attr("src", model.nationality.flag);
			}

			let selectModelIndex = 1;
			let modelNames = Object.keys(Ocean.Models);
			let modelLength = modelNames.length;

			let enableChange = true;
			
			const CenterPos = new THREE.Vector3(0, 100, -200);
			const StartDistX = 300;
			const  DisplayRot = [0.1, 0.5, 0];
			//const DisplayAngVel = new THREE.Vector3(0, 0.2 ,0);
			const ChangeTime = 0.5;
			let objectControl;

			let previousId;
			let nextId;

			function changeSelectModel(move){ 
				if(!enableChange)
					return;

				enableChange = false;
				
				previousId = nextId;//selectModelIndex + 1;
				oceanControl.updateFighter({
					vel: [StartDistX/ ChangeTime * move ,0 ,0] //,
					//angVel: new THREE.Vector3(0, 0, 0)
				}, previousId);

				selectModelIndex += move;
				if(selectModelIndex < 0)
					selectModelIndex += modelLength;
				else if(selectModelIndex >= modelLength )
					selectModelIndex -= modelLength;
				let modelName = modelNames[selectModelIndex];

				nextId = uuid();//selectModelIndex + 1;

				oceanControl.addFighter({
					modelName: modelName,
					pos: [CenterPos.x - move*StartDistX, 
							CenterPos.y, 
							CenterPos.z],
					rot: DisplayRot,
					vel : new THREE.Vector3(StartDistX/ChangeTime * move, 0,0),
					isPrivate: true
				} , nextId , true);

				setTimeout(function(){
					oceanControl.deleteFighter(previousId);

					oceanControl.updateFighter({
						vel: new THREE.Vector3(0,0,0),
						pos: [CenterPos.x, CenterPos.y, CenterPos.z],
					}, nextId);

					objectControl = oceanControl.setObjectControl(true, nextId, $(".select-fighter-container").get(0));

				}, ChangeTime * 1000);

				setTimeout(function(){
					/*oceanControl.updateFighter({
						angVel: DisplayAngVel.clone()
					}, nextId); */
					objectControl.autoRotate = true;
					enableChange = true;
				}, ChangeTime * 1000 + 200);

				setModelInSelect(modelName);
			}

			function setModelIntanceWithControl(infoControls, modelInstance){
				let mInstance = modelInstance;

				infoControls.$x_pos.change(function(){
					modelInstance.mesh.position.x =	$(this).val();
				});
				infoControls.$y_pos.change(function(){
					modelInstance.mesh.position.y =	$(this).val();
				});
				infoControls.$z_pos.change(function(){
					modelInstance.mesh.position.z =	$(this).val();
				});
				infoControls.$x_rot.change(function(){
					modelInstance.mesh.rotation.x =	$(this).val();
				});
				infoControls.$y_rot.change(function(){
					modelInstance.mesh.rotation.y =	$(this).val();
				});
				infoControls.$z_rot.change(function(){
					modelInstance.mesh.rotation.z =	$(this).val();
				});
			}

			// 被弾した
			function beShot(){
				//$(".blood-splash").show();
				$(".blood-splash").toggle();
			}

		});
		
		</script>
	</body>
</html>
