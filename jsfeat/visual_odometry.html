<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>JSFeat - JavaScript Computer Vision Library.</title>

    </head>
    <body>
            <video id="webcam" width="640" height="480" style="display:none;"></video>
            <div style=" width:640px;height:480px;margin: 10px auto;">
                <canvas id="canvas" width="640" height="480"></canvas>
                <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
                <div id="log" class="alert alert-info"></div>
            </div>

            <div id="pointer" style="width: 10px; height: 10px; background-color: red; border-radius: 10px; position: absolute;">
            </div>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="./jsfeat-min.js"></script>
        <script type="text/javascript" src="./compatibility.js"></script>
        <script type="text/javascript" src="./profile.js"></script>
        <script type="text/javascript" src="./dat.gui.min.js"></script>
        <script type="text/javascript" src="./visual_odometry.js"></script>

        <script type="text/javascript" src="./../webrtc/device_cam.js"></script>

        <script type="text/javascript" src="https://threejs.org/examples/js/libs/stats.min.js"></script>
        <script type="text/javascript">

        $(window).load(function() {
            "use strict";

            // lets do some fun
            var video = document.getElementById('webcam');
            var canvas = document.getElementById('canvas');
            var videoWidth, videoHeight;
            var odometry;
            var stats;

            var $pointer;

            var camController = new camera_controller(video);
            camController.startCamera();
            camController.addLoadedEventListener(function(width, heigh){
                videoWidth = width;
                videoHeight = heigh;
                demo_app();
                compatibility.requestAnimationFrame(tick);
            });

            // var stat = new profiler();

            stats = new Stats();
            document.body.appendChild( stats.dom );

            $pointer = $("#pointer");
            $pointer.setPosition = function(x, y){
                $(this).css("left", x + "px");
                $(this).css("top", y + "px");
            };

            var gui,options,ctx,canvasWidth,canvasHeight;
            var img_u8, corners, threshold;

            var demo_opt = function(){
                this.threshold = 20;
            }

            function demo_app() {
                canvasWidth  = canvas.width;
                canvasHeight = canvas.height;
                ctx = canvas.getContext('2d');

                ctx.fillStyle = "rgb(0,255,0)";
                ctx.strokeStyle = "rgb(0,255,0)";

                odometry = new VisualOdometry(videoWidth, videoHeight);

                odometry.setFastThreshold(20);
            }

            function tick() {
                compatibility.requestAnimationFrame(tick);
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
                    var imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);

                    odometry.update(imageData);

                    // render result back to canvas
                    var data_u32 = new Uint32Array(imageData.data.buffer);
                   // render_corners(corners, count, data_u32, 640);

                    ctx.putImageData(imageData, 0, 0);

                    var transition = odometry.getCameraTransitionParams();
                    $pointer.setPosition(transition.position[0], transition.position[1]);
                        /*
                    if(transition.position[0] != 0 || 
                        transition.position[1] != 0)
                        console.log(transition.position);
                        */

                }

                stats.update();
            }

            function render_corners(corners, count, img, step) {
                var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00;
                for(var i=0; i < count; ++i)
                {
                    var x = corners[i].x;
                    var y = corners[i].y;
                    var off = (x + y * step);
                    img[off] = pix;
                    img[off-1] = pix;
                    img[off+1] = pix;
                    img[off-step] = pix;
                    img[off+step] = pix;
                }
            }

            $(window).unload(function() {
                video.pause();
                video.src=null;
            });
        });
        </script>
    </body>
</html>
