<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
 <title>node sample</title>

<script src="./../jq.js"></script>

<!-- main js library -->
<script type="text/javascript" src="node_module.js"></script>

<!-- style for this library -->
<link href="node.css" rel="stylesheet" />

<!-- style for this sample -->
<link href="node_sample.css" rel="stylesheet" />

<!--  for syntax high light -->
<script src="../highlight/highlight.pack.js"></script>
<script src="../highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
<link href="../highlight/styles/solarized-dark.css" rel="stylesheet" />



</head>
<body style="margin: 0px"> 
<div class="cover-for-dialog"></div>
<div class="dialog">
    <pre><code class="html">
        var a = 2;
        for(var i=0; i<2;i++){

        };

    </code></pre>
</div>

<div class="node-container" style=" height: inherit;">
    <div class="editor-content">
        <!--<div class="editor-button" id="edit-button"> edit </div> -->
        <div class="editor-button momentary" id="add-node-button"> add node </div>
        <div class="editor-button toggle" id="add-line-button"> add connect </div>
        <div class="editor-button momentary" id="delete-button"> delete node </div>
        <div class="editor-button momentary" id="generate-button"> generate </div>
    </div>
    
    <div class="node-map" style="width: 80%;"></div>
    <div class="node-detail">
        <div class="key-column">node type </div>
        <div class="node-type value-column select-parent">
            <select id="node-type-select"></select>
        </div>
        <div class="node-type key-column"> node name </div>
        <div id="node-name" class="value-column"></div>
    </div>
</div>
<div class="node ellipse shadowing swipable" id="ori-node" style="top: 20px;"><div class="node-title flexiblebox">server</div></div>
</body>
<script type="text/javascript">
'use strict';
$(function () {
    var screenWidth,screenHeight;
    screenWidth = window.innerWidth;
    screenHeight = window.innerHeight;
    //$(".node-container").css("width", screenWidth + "px");
    $(".node-container").css("height", screenHeight + "px");
    var node_list = [
        {type: "client", name: "webGL", pos: [487,516], is_active: true},
        {type: "server", name: "server", pos: [523,213], is_active: true},
        {type: "local", name: "image recognition", pos: [300, 227], is_active: true}, //3
        {type: "main-node", name: "main", pos: [260 ,338], is_active: true},
        {type: "local", name: "camera input", pos: [210, 440], is_active: true},//5
        {type: "control", name: "control panel", pos: [212,139], is_active: true},
        {type: "local", name: "wroom master", pos: [61, 396], is_active: true},
        {type: "local", name: "apery thread", pos: [69, 266], is_active: true}, //8
        {type: "control", name: "CGIHttpServer", pos: [174, 221], is_active: true},
        {type: "real-world", name: "webcam", pos: [219, 554], is_active: true},//10
        {type: "client", name: "wroom", pos: [73, 562], is_active: true},
        {type: "local", name: "DNN", pos: [323, 130], is_active: false}
    ];
    var connect_list = [
        {nodes: [1,2]} , 
        {nodes: [2,4]},
        {nodes: [3,4]},
        {nodes: [4,5]},
        {nodes: [6,9]},
        {nodes: [4,7]},
        {nodes: [7,11]},
        {nodes: [4,8]},
        {nodes: [4,9]},
        {nodes: [3,12]},
        {nodes: [5,10]}
        ];
    var node_module = new NodeModule(node_list, connect_list);

    // nodeをクリックした際に呼ばれる
    node_module.click_callback = function(node_id){
        console.log(node_id + "dbclick");
        var node_data = this.node_list[node_id - 1];
        $("#node-type-select").val(node_data.type);
        $("#node-name").text(node_data.name);
    
        // connect　を追加
        if(is_add_connect_active){
            var node_id = node_module.focused_id();
            // 二つのnode間にconnectがなければ追加
            if(node_module.get_connect_id_by_node_ids(node_id, add_connect_id) == 0){
                var connect_data = {nodes:[add_connect_id, node_id]};
                node_module.generate_connect(connect_data);
            }
        }
    }   

    function setCursor(pos){
        $cursor.css("left", pos[0] + "px");
        $cursor.css("top", pos[1] + "px");
        $cursor.css("transform", "rotate(" + (- pos[3]*180 /3.14) + "deg)");
        //$cursor.css("zoom", (pos[2]/10.0 +100) + "%");
    }

    var node_types = [
        "client",
        "local",
        "server",
        "main-node",
        "control",
        "real-world"
    ];

    // add line の状態
    var is_add_connect_active = false;
    var add_connect_id = 0;


    /* editor buttons */ 
    $("#generate-button").bind("click",function(){
        $.get("./index.html", function(data){
             // syntax highlight
            //hljs.initHighlightingOnLoad();
            //hljs.initLineNumbersOnLoad();
            if(!code_highlight_flag){
                $(".dialog pre code").text(data);
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                    hljs.lineNumbersBlock(block);
                });   
                code_highlight_flag = true;    
            }

            $(".cover-for-dialog").show();
            $(".dialog").show();
        });
    });

    $("#add-node-button").bind("click", function(){
        node_module.create_new_node();
    });

    $("#add-line-button").bind("click", function(){
        is_add_connect_active = !(is_add_connect_active);
        if(is_add_connect_active){
            $(this).addClass("on");
            add_connect_id = node_module.focused_id();
        }else{
            $(this).removeClass("on");
        }
    });

    $("#delete-button").bind("click", function(){
        node_module.delete_node_with_connects(node_module.focused_id());
    });

    $(".cover-for-dialog").bind("click", function(){
        //$(".dialog pre code").text("");
        $(".cover-for-dialog").hide();
        $(".dialog").hide();
        
    });
    var code_highlight_flag = false;
   /*  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });*/



    /* edit form */
    for (var node_type of node_types){
        $("#node-type-select").append($("<option>").val(node_type).text(node_type));
    }

    $("#node-type-select").change(function(){
        var node_type = $("#node-type-select option:selected").val();
        node_module.update_node_data(node_module.focused_id(), {type: node_type});
    });

    $("#node-name").bind("click", function(){
        if(!$(this).hasClass("on")){
            $(this).addClass("on");
            var node_name = $(this).text();
            $(this).html(`<input type='text' value='${node_name}'/>`);
             $('#node-name > input').focus().blur(function(){
                var inputVal = $(this).val();
                if(inputVal===''){
                    inputVal = this.defaultValue;
                }else{
                    node_module.update_node_data(node_module.focused_id(), {name: inputVal})
                }
                $(this).parent().removeClass('on').text(inputVal);
            });
        }
    });
 

});            
</script>
</html>
